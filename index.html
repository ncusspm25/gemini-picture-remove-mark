<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Gemini å°ˆæ¥­ç„¡ç—•ä¿®å¾© v7.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f4f9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 95%; max-width: 500px; }
        #status { color: #888; margin: 15px 0; font-size: 14px; font-weight: bold; }
        .upload-area { border: 2px dashed #007bff; padding: 30px; border-radius: 15px; background: #f0f7ff; cursor: pointer; margin-bottom: 20px; }
        canvas { max-width: 100%; border-radius: 10px; display: none; margin-top: 15px; }
        .btn { display: inline-block; background: #28a745; color: white; padding: 12px 25px; border-radius: 10px; text-decoration: none; font-weight: bold; margin-top: 15px; border: none; }
        .btn:disabled { background: #ccc; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ¨ å°ˆæ¥­ç´šç„¡ç—•ä¿®å¾© v7.0</h2>
    <div id="status">æ­£åœ¨åˆå§‹åŒ– AI å¼•æ“ (OpenCV)...</div>

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <strong>é»æ“Šä¸Šå‚³åœ–ç‰‡</strong>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFile(this.files[0])">
    </div>

    <canvas id="outputCanvas"></canvas>
    
    <a id="downloadBtn" class="btn" style="display:none;">ä¸‹è¼‰å®Œç¾ç„¡ç—•åœ–ç‰‡</a>
</div>

<script async src="https://docs.opencv.org/4.5.2/opencv.js" onload="cvReady();"></script>

<script>
let cvLoaded = false;
function cvReady() {
    cvLoaded = true;
    document.getElementById('status').innerText = "âœ… å¼•æ“æº–å‚™å°±ç·’";
    document.getElementById('status').style.color = "#28a745";
}

function handleFile(file) {
    if (!file || !cvLoaded) return;
    const status = document.getElementById('status');
    status.innerText = "â³ æ­£åœ¨è¨ˆç®—åƒç´ ä¿®è£œ...";
    
    const img = new Image();
    img.onload = function() {
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        // --- æ ¸å¿ƒ OpenCV ä¿®å¾©é‚è¼¯ ---
        let src = cv.imread(img);
        let dst = new cv.Mat();
        
        // 1. å®šç¾©å³ä¸‹è§’ ROI (å±€éƒ¨å€åŸŸ) ä»¥åŠ é€Ÿé‹ç®—
        let roiSize = Math.round(src.cols * 0.1); // å–å³ä¸‹è§’ 10%
        let roiRect = new cv.Rect(src.cols - roiSize, src.rows - roiSize, roiSize, roiSize);
        let roiSrc = src.roi(roiRect);
        
        // 2. å»ºç«‹é®ç½© (é‡å°è±å½¢ä½ç½®)
        let mask = cv.Mat.zeros(roiSrc.rows, roiSrc.cols, cv.CV_8U);
        // åœ¨å±€éƒ¨å€åŸŸä¸­æ¨™è¨˜å³ä¸‹è§’ç‚ºéœ€è¦ä¿®è£œ
        let p1 = new cv.Point(roiSize * 0.2, roiSize * 0.2);
        let p2 = new cv.Point(roiSize, roiSize);
        cv.rectangle(mask, p1, p2, [255, 255, 255, 255], -1);

        // 3. åŸ·è¡Œå°ˆæ¥­ Inpaint æ¼”ç®—æ³• (Telea)
        let roiDst = new cv.Mat();
        cv.inpaint(roiSrc, mask, roiDst, 3, cv.INPAINT_TELEA);

        // 4. å°‡ä¿®è£œå¾Œçš„å±€éƒ¨å€åŸŸè²¼å›åŸåœ–
        // æˆ‘å€‘ç›´æ¥æ“ä½œ Canvas é€²è¡Œå±€éƒ¨è¦†è“‹ï¼Œæ•ˆæœæœ€æº–ç¢º
        let tempCanvas = document.createElement('canvas');
        cv.imshow(tempCanvas, roiDst);
        ctx.drawImage(tempCanvas, src.cols - roiSize, src.rows - roiSize);

        // 5. å®Œæˆ
        canvas.style.display = "block";
        status.innerText = "âœ¨ ä¿®å¾©å®Œæˆï¼";
        document.getElementById('downloadBtn').href = canvas.toDataURL();
        document.getElementById('downloadBtn').style.display = "inline-block";

        // é‡‹æ”¾è¨˜æ†¶é«”
        src.delete(); dst.delete(); roiSrc.delete(); roiDst.delete(); mask.delete();
    };
    const reader = new FileReader();
    reader.onload = (e) => img.src = e.target.result;
    reader.readAsDataURL(file);
}
</script>
</body>
</html>
