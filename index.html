<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Gemini é–ƒé›»å»æµ®æ°´å° v4.0</title>
    <style>
        body { font-family: 'PingFang TC', sans-serif; background: #f8f9fa; display: flex; flex-direction: column; align-items: center; padding: 30px; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); text-align: center; max-width: 600px; width: 100%; }
        #status { color: #d9534f; margin: 15px 0; font-weight: bold; }
        .canvas-container { margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #eee; }
        canvas { max-width: 100%; display: block; }
        .btn { display: inline-block; background: #007bff; color: white; padding: 12px 25px; border-radius: 5px; text-decoration: none; cursor: pointer; border: none; font-size: 16px; margin: 10px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .success-btn { background: #28a745; }
    </style>
</head>
<body>

<div class="container">
    <h2>âš¡ Gemini é–ƒé›»ä¿®å¾©å·¥å…·</h2>
    <div id="status">æ­£åœ¨åŠ è¼‰ OpenCV å¼•æ“...</div>

    <input type="file" id="fileInput" accept="image/*" style="display:none">
    <button class="btn" id="uploadBtn" disabled>1. é¸æ“‡å‰ä¼Šå¡å“‡åœ–ç‰‡</button>

    <div class="canvas-container">
        <canvas id="canvasOutput"></canvas>
    </div>

    <a id="downloadLink" class="btn success-btn" style="display:none;">2. ä¸‹è¼‰å®Œç¾ç„¡ç—•åœ–</a>
</div>

<script async src="https://docs.opencv.org/4.5.2/opencv.js" onload="onOpenCvReady();"></script>

<script>
let uploadBtn = document.getElementById('uploadBtn');
let status = document.getElementById('status');
let fileInput = document.getElementById('fileInput');
let canvas = document.getElementById('canvasOutput');
let ctx = canvas.getContext('2d');
let img = new Image();

function onOpenCvReady() {
    status.innerText = "âœ… å¼•æ“æº–å‚™å°±ç·’";
    status.style.color = "#28a745";
    uploadBtn.disabled = false;
}

uploadBtn.onclick = () => fileInput.click();

fileInput.onchange = (e) => {
    let reader = new FileReader();
    reader.onload = (event) => {
        img.src = event.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
};

img.onload = function() {
    // 1. å…ˆå°‡åŸåœ–ç•«å…¥ Canvas
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
    
    status.innerText = "ğŸš€ æ­£åœ¨é€²è¡Œå±€éƒ¨é–ƒé›»ä¿®å¾©...";
    
    // çµ¦ç€è¦½å™¨ä¸€é»æ™‚é–“é¡¯ç¤ºç‹€æ…‹æ›´æ–°
    setTimeout(fastInpaint, 50);
};

function fastInpaint() {
    // å–å¾—åœ–ç‰‡å¯¬é«˜
    const w = canvas.width;
    const h = canvas.height;

    // 2. å®šç¾©å³ä¸‹è§’ã€Œå±€éƒ¨å€åŸŸã€ (ROI)
    // é è¨­æŠ“å–å³ä¸‹è§’ 150x150 åƒç´ ï¼Œé€™è¶³ä»¥æ‡‰ä»˜å¤§å¤šæ•¸ 2K åœ–ç‰‡
    const roiW = Math.min(w, 180);
    const roiH = Math.min(h, 180);
    const roiX = w - roiW;
    const roiY = h - roiH;

    // 3. è®€å–åŸåœ–
    let fullSrc = cv.imread(img);
    
    // 4. å‰ªè£å‡ºå±€éƒ¨å€åŸŸé€²è¡Œé‹ç®—
    let rect = new cv.Rect(roiX, roiY, roiW, roiH);
    let roiSrc = fullSrc.roi(rect);
    let roiDst = new cv.Mat();
    let mask = cv.Mat.zeros(roiSrc.rows, roiSrc.cols, cv.CV_8U);

    // åœ¨å±€éƒ¨å€åŸŸä¸­å»ºç«‹é®ç½© (è±å½¢é€šå¸¸åœ¨å±€éƒ¨åº§æ¨™çš„æœ€å³ä¸‹è§’)
    // æˆ‘å€‘å°‡å±€éƒ¨å€åŸŸçš„å¾Œ 70% å€åŸŸæ¨™è¨˜ç‚ºéœ€è¦ä¿®å¾©
    let p1 = new cv.Point(roiW * 0.3, roiH * 0.3);
    let p2 = new cv.Point(roiW, roiH);
    cv.rectangle(mask, p1, p2, [255, 255, 255, 255], -1);

    // 5. é‡å°å±€éƒ¨å€åŸŸåŸ·è¡Œä¿®å¾© (é€™æ­¥ç¾åœ¨è¶…å¿«ï¼)
    cv.inpaint(roiSrc, mask, roiDst, 3, cv.INPAINT_TELEA);

    // 6. å°‡ä¿®å¾©å¾Œçš„å±€éƒ¨å€å¡Šè²¼å›ç•«å¸ƒ
    cv.imshow('canvasOutput', fullSrc); // å…ˆç•«å…¨åœ–
    
    // è½‰æ›å±€éƒ¨ Mat å› Canvas
    let tempCanvas = document.createElement('canvas');
    cv.imshow(tempCanvas, roiDst);
    ctx.drawImage(tempCanvas, roiX, roiY);

    // 7. å®Œæˆ
    status.innerText = "âœ¨ ä¿®å¾©å®Œæˆï¼";
    document.getElementById('downloadLink').href = canvas.toDataURL();
    document.getElementById('downloadLink').style.display = 'inline-block';

    // é‡‹æ”¾è¨˜æ†¶é«”
    fullSrc.delete(); roiSrc.delete(); roiDst.delete(); mask.delete();
}
</script>

</body>
</html>
