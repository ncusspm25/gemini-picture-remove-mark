<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Gemini ç„¡ç—•ä¿®å¾© v9.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 95%; max-width: 500px; }
        
        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-container { display: none; width: 100%; background-color: #eee; border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .progress-bar { width: 0%; height: 20px; background-color: #007bff; transition: width 0.3s; }
        
        #status { color: #555; margin: 10px 0; font-size: 14px; font-weight: bold; }
        .upload-area { border: 2px dashed #007bff; padding: 30px; border-radius: 15px; background: #f8fbff; cursor: pointer; }
        canvas { max-width: 100%; border-radius: 10px; display: none; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn { display: inline-block; background: #28a745; color: white; padding: 12px 25px; border-radius: 10px; text-decoration: none; font-weight: bold; margin-top: 15px; border: none; }
        .timer { font-size: 12px; color: #999; margin-top: 5px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ¨ æ™ºæ…§ç„¡ç—•ä¿®å¾© v9.0</h2>
    <div id="status">æ­£åœ¨åŠ è¼‰ AI æ ¸å¿ƒ (OpenCV)...</div>
    
    <div class="progress-container" id="pContainer">
        <div class="progress-bar" id="pBar"></div>
    </div>
    <div class="timer" id="timerText"></div>

    <div class="upload-area" id="dropZone">
        <strong>é»æ“Šé¸æ“‡åœ–ç‰‡</strong>
        <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>

    <canvas id="outputCanvas"></canvas>
    
    <a id="downloadBtn" class="btn" style="display:none;">ä¸‹è¼‰çµæœ</a>
</div>

<script async src="https://docs.opencv.org/4.5.2/opencv.js" onload="cvReady();"></script>

<script>
let cvLoaded = false;
const status = document.getElementById('status');
const pBar = document.getElementById('pBar');
const pContainer = document.getElementById('pContainer');
const timerText = document.getElementById('timerText');
const canvas = document.getElementById('outputCanvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

function cvReady() {
    cvLoaded = true;
    status.innerText = "âœ… å¼•æ“å·²å°±ç·’";
    status.style.color = "#28a745";
}

document.getElementById('dropZone').onclick = () => document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange = (e) => handleFile(e.target.files[0]);

function updateProgress(percent, msg, timeRem) {
    pBar.style.width = percent + "%";
    status.innerText = msg;
    if (timeRem) timerText.innerText = `é è¨ˆå‰©é¤˜æ™‚é–“: ${timeRem} ç§’`;
    else timerText.innerText = "";
}

function handleFile(file) {
    if (!file || !cvLoaded) return;
    
    pContainer.style.display = "block";
    updateProgress(10, "æ­£åœ¨è®€å–åœ–ç‰‡...", 5);
    
    const img = new Image();
    img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        updateProgress(30, "æ­£åœ¨åˆ†æç´‹ç†...", 4);

        // ä½¿ç”¨ setTimeout è®“ UI æœ‰æ©Ÿæœƒæ›´æ–°é€²åº¦æ¢
        setTimeout(() => {
            updateProgress(50, "æ­£åœ¨é–å®šå³ä¸‹è§’å€åŸŸ...", 3);
            
            setTimeout(() => {
                const w = img.width;
                const h = img.height;
                const roiSize = Math.round(w * 0.12);
                const roiX = w - roiSize;
                const roiY = h - roiSize;

                updateProgress(70, "AI æ­£åœ¨è¨ˆç®—åƒç´ å¡«å……...", 2);

                setTimeout(() => {
                    // åŸ·è¡Œ OpenCV é‹ç®—
                    try {
                        const roiData = ctx.getImageData(roiX, roiY, roiSize, roiSize);
                        let src = cv.matFromImageData(roiData);
                        let mask = cv.Mat.zeros(src.rows, src.cols, cv.CV_8U);
                        let p1 = new cv.Point(roiSize * 0.1, roiSize * 0.1);
                        let p2 = new cv.Point(roiSize, roiSize);
                        cv.rectangle(mask, p1, p2, [255, 255, 255, 255], -1);

                        let dst = new cv.Mat();
                        cv.inpaint(src, mask, dst, 3, cv.INPAINT_TELEA);

                        const tempCanvas = document.createElement('canvas');
                        cv.imshow(tempCanvas, dst);
                        ctx.drawImage(tempCanvas, roiX, roiY);

                        updateProgress(100, "âœ¨ ä¿®å¾©å®Œæˆï¼", 0);
                        canvas.style.display = "block";
                        document.getElementById('downloadBtn').href = canvas.toDataURL();
                        document.getElementById('downloadBtn').style.display = "inline-block";

                        src.delete(); mask.delete(); dst.delete();
                    } catch (e) {
                        status.innerText = "âŒ é‹ç®—éŒ¯èª¤ï¼Œè«‹é‡è©¦";
                        console.error(e);
                    }
                }, 100);
            }, 500);
        }, 500);
    };
    const reader = new FileReader();
    reader.onload = (e) => img.src = e.target.result;
    reader.readAsDataURL(file);
}
</script>
</body>
</html>
