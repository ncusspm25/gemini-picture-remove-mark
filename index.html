<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Gemini çµ‚æ¥µç„¡ç—•ä¿®å¾© v8.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 95%; max-width: 500px; }
        #status { color: #888; margin: 15px 0; font-size: 14px; font-weight: bold; }
        .upload-area { border: 2px dashed #007bff; padding: 30px; border-radius: 15px; background: #f8fbff; cursor: pointer; }
        canvas { max-width: 100%; border-radius: 10px; display: none; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn { display: inline-block; background: #28a745; color: white; padding: 12px 25px; border-radius: 10px; text-decoration: none; font-weight: bold; margin-top: 15px; border: none; }
        .loading-spinner { display: none; width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ¨ çµ‚æ¥µç„¡ç—•ä¿®å¾© v8.0</h2>
    <div id="status">æ­£åœ¨åŠ è¼‰ AI æ ¸å¿ƒ...</div>
    <div class="loading-spinner" id="spinner"></div>

    <div class="upload-area" id="dropZone">
        <strong>é»æ“Šæˆ–ä¸Šå‚³å‰ä¼Šå¡å“‡åœ–</strong>
        <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>

    <canvas id="outputCanvas"></canvas>
    
    <a id="downloadBtn" class="btn" style="display:none;">ä¸‹è¼‰å®Œç¾ç„¡ç—•åœ–ç‰‡</a>
</div>

<script async src="https://docs.opencv.org/4.5.2/opencv.js" onload="cvReady();"></script>

<script>
let cvLoaded = false;
const status = document.getElementById('status');
const spinner = document.getElementById('spinner');
const canvas = document.getElementById('outputCanvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

function cvReady() {
    cvLoaded = true;
    status.innerText = "âœ… å¼•æ“å·²å°±ç·’ï¼Œè«‹ä¸Šå‚³åœ–ç‰‡";
    status.style.color = "#28a745";
}

document.getElementById('dropZone').onclick = () => document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange = (e) => handleFile(e.target.files[0]);

function handleFile(file) {
    if (!file || !cvLoaded) return;
    status.innerText = "â³ æ­£åœ¨é€²è¡Œå±€éƒ¨ç„¡ç—•ä¿®å¾©...";
    spinner.style.display = "block";
    
    const img = new Image();
    img.onload = () => {
        // 1. æº–å‚™ç•«å¸ƒ
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        // --- æ ¸å¿ƒå„ªåŒ–ï¼šåªè™•ç†å³ä¸‹è§’å€åŸŸ (ROI) ---
        setTimeout(() => {
            const w = img.width;
            const h = img.height;
            const roiSize = Math.round(w * 0.12); // å– 12% çš„å€åŸŸï¼Œç¢ºä¿è±å½¢è¢«åŒ…é€²å»
            const roiX = w - roiSize;
            const roiY = h - roiSize;

            // 2. åƒ…å°‡å³ä¸‹è§’å€åŸŸè®€å…¥ OpenCV (é€™æ­¥æ˜¯é˜²å¡æ­»çš„é—œéµ)
            const roiData = ctx.getImageData(roiX, roiY, roiSize, roiSize);
            let src = cv.matFromImageData(roiData);
            let mask = cv.Mat.zeros(src.rows, src.cols, cv.CV_8U);

            // 3. åœ¨é€™å°å¡Šå€åŸŸå»ºç«‹é®ç½© (è±å½¢é€šå¸¸åœ¨å³ä¸‹è§’)
            let p1 = new cv.Point(roiSize * 0.1, roiSize * 0.1);
            let p2 = new cv.Point(roiSize, roiSize);
            cv.rectangle(mask, p1, p2, [255, 255, 255, 255], -1);

            // 4. åŸ·è¡Œå°ˆæ¥­ç´šåƒç´ å¡«è£œ (Inpaint)
            let dst = new cv.Mat();
            cv.inpaint(src, mask, dst, 3, cv.INPAINT_TELEA);

            // 5. å°‡çµæœè½‰å›ç•«å¸ƒ
            const tempCanvas = document.createElement('canvas');
            cv.imshow(tempCanvas, dst);
            ctx.drawImage(tempCanvas, roiX, roiY);

            // 6. å®Œå·¥èˆ‡é‡‹æ”¾
            canvas.style.display = "block";
            status.innerText = "âœ¨ ä¿®å¾©å®Œæˆï¼";
            spinner.style.display = "none";
            document.getElementById('downloadBtn').href = canvas.toDataURL();
            document.getElementById('downloadBtn').style.display = "inline-block";

            src.delete(); mask.delete(); dst.delete();
        }, 100);
    };
    const reader = new FileReader();
    reader.onload = (e) => img.src = e.target.result;
    reader.readAsDataURL(file);
}
</script>
</body>
</html>
