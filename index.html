<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Gemini ç„¡ç—•ä¿®å¾© v10.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 95%; max-width: 500px; }
        .progress-container { display: none; width: 100%; background-color: #eee; border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .progress-bar { width: 0%; height: 20px; background-color: #28a745; transition: width 0.3s; }
        #status { color: #555; margin: 10px 0; font-size: 14px; font-weight: bold; }
        .upload-area { border: 2px dashed #007bff; padding: 30px; border-radius: 15px; background: #f8fbff; cursor: pointer; }
        canvas { max-width: 100%; border-radius: 10px; display: none; margin-top: 15px; }
        .btn { display: inline-block; background: #007bff; color: white; padding: 12px 25px; border-radius: 10px; text-decoration: none; font-weight: bold; margin-top: 15px; border: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ¨ æ™ºæ…§ç„¡ç—•ä¿®å¾© v10.0</h2>
    <div id="status">æ­£åœ¨åŠ è¼‰æ ¸å¿ƒ...</div>
    
    <div class="progress-container" id="pContainer">
        <div class="progress-bar" id="pBar"></div>
    </div>

    <div class="upload-area" id="dropZone">
        <strong>é»æ“Šä¸Šå‚³å‰ä¼Šå¡å“‡åœ–ç‰‡</strong>
        <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>

    <canvas id="outputCanvas"></canvas>
    <a id="downloadBtn" class="btn" style="display:none; background:#28a745;">ä¸‹è¼‰åœ–ç‰‡</a>
</div>

<script async src="https://docs.opencv.org/4.5.2/opencv.js" onload="cvReady();"></script>

<script>
let cvLoaded = false;
const status = document.getElementById('status');
const pBar = document.getElementById('pBar');
const pContainer = document.getElementById('pContainer');
const canvas = document.getElementById('outputCanvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

function cvReady() {
    cvLoaded = true;
    status.innerText = "âœ… å¼•æ“å°±ç·’";
}

document.getElementById('dropZone').onclick = () => document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange = (e) => handleFile(e.target.files[0]);

function handleFile(file) {
    if (!file || !cvLoaded) return;
    pContainer.style.display = "block";
    pBar.style.width = "20%";
    status.innerText = "è®€å–ä¸­...";
    
    const img = new Image();
    img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        setTimeout(() => {
            const w = canvas.width;
            const h = canvas.height;
            
            // --- å®‰å…¨è¨ˆç®—å€åŸŸ (ROI) ---
            // ç¢ºä¿ä¿®è£œç¯„åœä¸æœƒå¤§æ–¼æ•´å¼µåœ–ç‰‡
            let roiSize = Math.min(Math.round(w * 0.15), Math.round(h * 0.15), 300);
            let roiX = w - roiSize;
            let roiY = h - roiSize;

            pBar.style.width = "60%";
            status.innerText = "AI åƒç´ é‹ç®—ä¸­...";

            setTimeout(() => {
                try {
                    // å¾ Canvas æŠ“å–å±€éƒ¨æ•¸æ“š
                    let roiData = ctx.getImageData(roiX, roiY, roiSize, roiSize);
                    let src = cv.matFromImageData(roiData);
                    let mask = cv.Mat.zeros(src.rows, src.cols, cv.CV_8U);
                    
                    // å»ºç«‹é®ç½©ç¯„åœï¼šé–å®šå³ä¸‹è§’çš„è±å½¢ä½ç½®
                    // p1 è¨­å®šç‚ºå±€éƒ¨å€åŸŸçš„ 20% ä½ç½®ï¼Œç¢ºä¿åŒ…è¦†è±å½¢
                    let p1 = new cv.Point(Math.round(roiSize * 0.2), Math.round(roiSize * 0.2));
                    let p2 = new cv.Point(roiSize, roiSize);
                    cv.rectangle(mask, p1, p2, [255, 255, 255, 255], -1);

                    let dst = new cv.Mat();
                    // åŸ·è¡Œå°ˆæ¥­ä¿®å¾©
                    cv.inpaint(src, mask, dst, 3, cv.INPAINT_TELEA);

                    // å°‡çµæœç•«å›ç•«å¸ƒ
                    let tempCanvas = document.createElement('canvas');
                    cv.imshow(tempCanvas, dst);
                    ctx.drawImage(tempCanvas, roiX, roiY);

                    pBar.style.width = "100%";
                    status.innerText = "âœ¨ ä¿®å¾©æˆåŠŸï¼";
                    canvas.style.display = "block";
                    document.getElementById('downloadBtn').href = canvas.toDataURL();
                    document.getElementById('downloadBtn').style.display = "inline-block";

                    src.delete(); mask.delete(); dst.delete();
                } catch (err) {
                    console.error(err);
                    status.innerText = "âŒ å¤±æ•—ï¼šåœ–ç‰‡è§£æåº¦ä¸ç›¸å®¹";
                }
            }, 100);
        }, 500);
    };
    const reader = new FileReader();
    reader.onload = (e) => img.src = e.target.result;
    reader.readAsDataURL(file);
}
</script>
</body>
</html>
